<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php echo $this->getChildHtml('product_search_bar') ?>

<div class="span-18 last">  
<?php 
$_productCollection = Mage::getResourceModel('catalog/product_collection')
                            ->addAttributeToSelect(Mage::getSingleton('catalog/config')->getProductAttributes());

if($_GET['q'] != 'search_by_advanced_parameters')
{
    $_productCollection->addAttributeToFilter(array(
        array('attribute' => 'name', 'like' => $_GET['q'])
    ));
}
else
{
    $_productCollection->addAttributeToFilter('price', array('gt' => $_GET['min_cost']))
                       ->addAttributeToFilter('price', array('lt' => $_GET['max_cost']))
                       ->addAttributeToFilter(array(
                            array('attribute' => 'height', array('gt' => (int)$_GET['min_height']))
                        ))
                        ->addAttributeToFilter(array(
                            array('attribute' => 'height', array('lt' => (int)$_GET['max_height']))
                        ))
                       ->addAttributeToFilter(array(
                            array('attribute' => 'size', array('gt' => (int)$_GET['min_size']))
                        ))
                        ->addAttributeToFilter(array(
                            array('attribute' => 'size', array('lt' => (int)$_GET['max_size']))
                        ));
    if($_GET['designer'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'designer_select', 'like' => $_GET['designer'])
                        ));
    if($_GET['neckline'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'neckline', 'like' => $_GET['neckline'])
                        ));
    if($_GET['silhouette'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'silhouette', 'like' => $_GET['silhouette'])
                        ));
    if($_GET['fabric'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'fabric', 'like' => $_GET['fabric'])
                        ));
    if($_GET['bridal_style'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'bridal_style', 'like' => $_GET['bridal_style'])
                        ));
    if($_GET['body_type'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'body_type', 'like' => $_GET['body_type'])
                        ));
}

$total = $_productCollection->count();

$limit = 6;
if(isset($_GET['page']))
    $current_page = $_GET['page'];
else
    $current_page = 1;

$_productCollection = $_productCollection = Mage::getResourceModel('catalog/product_collection')
                            ->addAttributeToSelect(Mage::getSingleton('catalog/config')
                            ->getProductAttributes())
                            ->setCurPage($current_page)->setPageSize($limit);

if($_GET['q'] != 'search_by_advanced_parameters')
{
    $_productCollection->addAttributeToFilter(array(
        array('attribute' => 'name', 'like' => $_GET['q'])
    ));
}
else
{
    /*$_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'designer_select', 'like' => $_GET['designer'])
                        ));*/
    $_productCollection->addAttributeToFilter('price', array('gt' => $_GET['min_cost']))
                       ->addAttributeToFilter('price', array('lt' => $_GET['max_cost']))
                       ->addAttributeToFilter(array(
                            array('attribute' => 'height', array('gt' => (int)$_GET['min_height']))
                        ))
                        ->addAttributeToFilter(array(
                            array('attribute' => 'height', array('lt' => (int)$_GET['max_height']))
                        ))
                       ->addAttributeToFilter(array(
                            array('attribute' => 'size', array('gt' => (int)$_GET['min_size']))
                        ))
                        ->addAttributeToFilter(array(
                            array('attribute' => 'size', array('lt' => (int)$_GET['max_size']))
                        ));
    if($_GET['designer'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'designer_select', 'like' => $_GET['designer'])
                        ));
    if($_GET['neckline'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'neckline', 'like' => $_GET['neckline'])
                        ));
    if($_GET['silhouette'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'silhouette', 'like' => $_GET['silhouette'])
                        ));
    if($_GET['fabric'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'fabric', 'like' => $_GET['fabric'])
                        ));
    if($_GET['bridal_style'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'bridal_style', 'like' => $_GET['bridal_style'])
                        ));
    if($_GET['body_type'] != 0)
        $_productCollection->addAttributeToFilter(array(
                            array('attribute' => 'body_type', 'like' => $_GET['body_type'])
                        ));
}
?>

<?php if(!$_productCollection->count()){ ?>
                            <p class="note-msg"><?php echo $this->__('There are no products matching the selection.') ?></p>
                        <?php } else { $cnt = 0;?>
                            <?php foreach ($_productCollection as $_product)  {
                                $product = Mage::getModel('catalog/product')->load($_product->getId());
                                $prod_image = "";
                                foreach ($product->getMediaGalleryImages() as $image) {
                                    $prod_image = $image->getUrl();
                                    break;
                                }
                                if($prod_image == "")
                                    $prod_image = $product->getImageUrl();
                                ?>
                            <div class="span-6 last product_box">
                                <a href="<?php echo $_product->getProductUrl() ?>">
                                    <img src="<?php echo $prod_image; ?>" style="width:220px; height: 335px;"/>
                                </a>
				<div class="product_details">
					<h3><a href="<?php echo $_product->getProductUrl() ?>"><?php echo $product->getName();?>
                                                #<?php echo $product->getSKU();?>,
                                                Casual Dress Size <?php echo $product->getData('size');?> - New</a></h3>
					Retail: <span class="retail">$<?php echo ((int)$product->getPrice());?><sup>00</sup></span><br />

                                        <?php if((int)$product->getSpecialPrice() != 0) { ?>
					<div class="eb_cost">EB Cost: $<?php echo ((int)$product->getSpecialPrice());?><sup>00</sup></div>
					Save: $<?php echo ((int)$product->getPrice() - (int)$product->getSpecialPrice());?><sup>00</sup><br />
                                        <?php } else { ?>
                                        <div class="eb_cost">EB Cost: $<?php echo ((int)$product->getPrice());?><sup>00</sup></div>
					Save: $0<sup>00</sup><br />
                                        <?php } ?>

					<a href="<?php echo $_product->getProductUrl() ?>" class="more">More Information</a>
				</div>
                            </div>
                            <?php if(($cnt+1)%3 == 0) { ?> <br clear="both" /> <?php } ?>
                            <?php $cnt++; } ?>
                        <?php if(($cnt+1)%3 != 0) { ?> <br clear="both" /> <?php }} ?>

                </div>
		<br clear="both" />
		<hr />

                <?php
                $url = "http://".$_SERVER['HTTP_HOST']."".$_SERVER['PHP_SELF']."?";
                foreach($_GET as $key=>$value)
                    $url .= $key."=".$value."&";
                ?>

                <?php if($current_page > 1) { ?>
                <div class="left"><a href="<?php echo $url."page=".($current_page - 1);?>" class="less">PREVIOUS</a></div>
                <?php } ?>
                <?php if($total > ($current_page * $limit)) { ?>
		<div class="right"><a href="<?php echo $url."page=".($current_page + 1);?>" class="more">MORE</a></div>
                <?php } ?>
		<br clear="both" />

		<hr />
