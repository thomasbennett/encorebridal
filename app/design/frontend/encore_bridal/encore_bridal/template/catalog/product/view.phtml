<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php
    $_product = $this->getProduct();
    $_helper = $this->helper('catalog/output');
    $product = Mage::getModel('catalog/product')->load($_product->getId());
?>

<?php
/**
* Determine the previous/next link and link to current category
*/

$_ccat = Mage::getModel('catalog/category');
$_ccat->load($_product->getCategoryId());
$ppos         = $_ccat->getProductsPosition();
$current_pid  = $this->helper('catalog/data')->getProduct()->getId();

// build array from products positions
$plist = array();
foreach ($ppos as $pid => $pos) {
$plist[] = $pid;
}
$curpos   = array_search($current_pid, $plist);
// get link for prev product
$previd   = isset($plist[$curpos+1])? $plist[$curpos+1] : $current_pid;
$product  = Mage::getModel('catalog/product')->load($previd);
$prevpos  = $curpos;
while (!$product->isVisibleInCatalog()) {
$prevpos += 1;
$nextid   = isset($plist[$prevpos])? $plist[$prevpos] : $current_pid;
$product  = Mage::getModel('catalog/product')->load($nextid);
}
$prev_url = $product->getProductUrl();

// get link for next product
$nextid   = isset($plist[$curpos-1])? $plist[$curpos-1] : $current_pid;
$product  = Mage::getModel('catalog/product')->load($nextid);
$nextpos  = $curpos;
while (!$product->isVisibleInCatalog()) {
$nextpos -= 1;
$nextid   = isset($plist[$nextpos])? $plist[$nextpos] : $current_pid;
$product  = Mage::getModel('catalog/product')->load($nextid);
}
$next_url = $product->getProductUrl();

// get link for current category
$more_url = $_ccat->getUrl();
?>

<script type="text/javascript">
		$j(document).ready(function() {
			$j('#product_detail_tabs').tabs();
			$j('#more_tabs').tabs();
		})
	</script>

<!-- PRODUCT IMAGES -->
		<div class="span-8" id="product_images">
			<?php echo $this->getLayout()->getBlock('breadcrumbs')->toHtml();?>
                        <?php echo $this->getChildHtml('media') ?>
                </div>


		<!-- PROODUCT DETAILS -->
		<div class="span-11 prepend-1 append-1">
			<hr />

			<h1 class="product_title"><?php echo $_product->getAttributeText('designer_select');?> Custom "<?php echo $_product->getName();?>", Casual Dress Size <?php echo $_product->getData('size');?></h1>

			<hr />

			<div class="large_retail">Retail: <span class="retail">$<?php echo ((int)$_product->getPrice());?><sup>00</sup></span></div>

                        <?php if((int)$_product->getSpecialPrice() != 0) { ?>
			<div class="large_eb_cost">EB Cost: $<?php echo ((int)$_product->getSpecialPrice());?><sup>00</sup></div>
			<div class="large_savings">Save: $<?php echo ((int)$_product->getPrice() - (int)$_product->getSpecialPrice());?><sup>00</sup></div>
                        <?php } else { ?>
                        <div class="large_eb_cost">Encore Bridal Cost: $<?php echo ((int)$_product->getPrice());?><sup>00</sup></div>
			<div class="large_savings">Save: $0<sup>00</sup></div>
                        <?php } ?>

                        <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
                            <?php echo $this->getChildHtml('addtocart');?>
                        </form>

                        <?php if ($this->helper('wishlist')->isAllow()) : ?>
                            <?php echo $this->getChildHtml('addtowishlist');?>
                        <?php endif; ?>
                
			<hr />

			<!-- TABS -->
			<div id="product_detail_tabs" class="tabs">
				<ul>
					<li><a href="#product_detail_tabs-1">Details</a></li>
					<li><a href="#product_detail_tabs-2">Size/Fit</a></li>
					<li><a href="#product_detail_tabs-3">Condition</a></li>
					<li><a href="#product_detail_tabs-4">Designer</a></li>
				</ul>
				<div id="product_detail_tabs-1"><?php echo $this->helper('catalog/output')->productAttribute($this->getProduct(), nl2br($this->getProduct()->getDescription()), 'description')?></div>
				<div id="product_detail_tabs-2">
                                    <span class="product_height">Height: </span>
                                        <?php
                                            $prod_height = $_product->getData('height');
                                            echo floor($prod_height / 12)."'".($prod_height % 12).'"';
                                        ?>
                                    <br/>
                                    <?php echo $_product->getData('sizefit');?>
                                </div>
				<div id="product_detail_tabs-3"><?php echo $_product->getData('conditions');?></div>
				<div id="product_detail_tabs-4">
                                    <span class="product_designer">Designer: </span><?php echo $_product->getAttributeText('designer_select');?>
                                    <br/>
                                    <?php echo $_product->getData('designer');?>
                                </div>
			</div>

                        <?php
                            $url = $_product->getProductUrl();
                            $url = preg_replace("/:/", "%3A", $url);
                            $url = preg_replace("/\//", "%2F", $url);
                        ?>
			<!-- AddThis Button BEGIN -->
			<div class="addthis_toolbox addthis_default_style ">
				<a class="addthis_button_email"></a>
				<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
				<a class="addthis_button_tweet" style="width: 90px;"></a>
				<a class="addthis_button_google_plusone" g:plusone:size="medium" style="width: 71px;"></a>
				<a class="addthis_counter addthis_pill_style" style="width: 57px;"></a>
                                
        <a href="http://pinterest.com/pin/create/button/?url=<?php echo $url;?>" class="pin-it-button" count-layout="horizontal">Pin It</a>
        <script type="text/javascript" src="http://assets.pinterest.com/js/pinit.js"></script>
			</div>
			<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4ec1288610fe69e0"></script>
			<!-- AddThis Button END -->

		</div>

		<!-- FINISH THE LOOK -->
		<div class="span-3 last" id="finish_the_look">
			<h5>Finish the Look</h5>
                        <?php echo $this->getChildHtml('related_products2'); ?>
                </div>

		<br clear="both" />
		<hr />

		<!-- TABBED CONTENT -->
		<div id="more_tabs" class="tabs">
			<ul>
				<li><a href="#more_tabs-1">Related Products</a></li>
				<li><a href="#more_tabs-2">Return Policy</a></li>
				<li><a href="#more_tabs-3">Worry Free Guarantee</a></li>
			</ul>
			<div id="more_tabs-1">
                            <?php echo $this->getChildHtml('related_products'); ?>
                        <br clear="both" />

			</div>
			<div id="more_tabs-2"><?php echo $_product->getData('returnpolicy');?></div>
			<div id="more_tabs-3"><?php echo $_product->getData('freeguarantee');?></div>
		</div>
		<hr />
		<!-- PAGINATION -->
                <?php  if($_product->getProductUrl()!= $next_url){ ?>
		<div class="left"><a href="<?php echo $next_url;?>" class="less">PREVIOUS</a></div>
                <?php } ?>
                <?php  if($_product->getProductUrl()!= $prev_url){ ?>
		<div class="right"><a href="<?php  echo $prev_url;?>" class="more">MORE</a></div>
                <?php } ?>
		<br clear="both" />

		<hr />
